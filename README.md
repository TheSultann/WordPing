# WordPing — Telegram бот для интервальных повторений

## Быстрый старт
1. Node.js 18+ и PostgreSQL.
2. Установи зависимости: 
pm install.
3. Скопируй .env.example в .env и задай:
   - BOT_TOKEN — токен бота от BotFather.
   - DATABASE_URL — строка подключения Postgres (можно Supabase).
4. Сгенерируй клиент: 
px prisma generate.
5. Прогоняй миграции: 
px prisma migrate deploy (или 
px prisma migrate dev --name init).
6. Запусти бота и воркер в двух процессах:
   - 
pm run dev:bot
   - 
pm run dev:worker
   Для продакшена: 
pm run build + 
pm run start:bot и 
pm run start:worker.

## Что делает
- /add — добавление слова (бот предложит перевод из мини-словаря, иначе попросит ввести вручную).
- Уведомления идут по nextReviewAt (UTC в БД), направление карточек выбирается 50/50 EN↔RU.
- Проверка ответов без учёта регистра и лишних пробелов, для RU→EN принимаются варианты с артиклями.
- Оценки Hard/Good/Easy двигают по фиксированной лестнице интервалов: 5 мин → 25 мин → 2 ч → 1 д → 3 д → 7 д → 16 д → 35 д.
  - Hard: шаг назад по лестнице.
  - Good: шаг вперёд.
  - Easy: если стадия ≤2 — прыжок сразу на 3 дня, иначе +2 стадии.
- Напоминания: +5 мин и +20 мин, затем пропуск (слово возвращается через 1 час, stage 0).
- Стрик по дням: если за день выполнено 3 задания — стрик растёт, пропущенный день сбрасывает.
- Настройки и статистика доступны в Mini App: команды /settings и /stats открывают Web-приложение (кнопка открывается, если задан WEBAPP_URL).

## Структура
- src/bot — обработчики команд и FSM.
- src/scheduler — крон-воркер (каждую минуту рассылает задания и напоминания).
- src/services — логика SRS, проверки ответов, работа с пользователями/сессиями.
- src/db — Prisma client.
- prisma/ — схема и миграции (prisma/migrations/0001_init).

## Хранение
- Времена в БД — UTC.
- Пользовательские окна уведомлений в минутах от 00:00 (по умолчанию 08:00–23:00). При проверке используется timezone пользователя (если не задан — UTC).

## Полезные команды
- 
pm run migrate:dev — prisma migrate dev.
- 
pm run migrate:deploy — применить миграции в проде.
- 
pm run prisma:generate — пересоздать клиент.

Логи пишутся в stdout/stderr (Telegraf и воркер).

## Mini App (Web) и API
Локальный запуск:
1. Установи зависимости веб-приложения:
   - `npm --prefix web install`
2. Запусти API:
   - `npm run dev:api`
3. Запусти Web App:
   - `npm run dev:web`
4. Для реферальных ссылок укажи `VITE_BOT_USERNAME` в `web/.env`.
5. Укажи `WEBAPP_URL` в `.env`, чтобы бот отправлял кнопку открытия приложения.
6. Для локального теста без Telegram включи `ALLOW_DEV_AUTH=true` и используй `?devUserId=123`.
7. Авторизация Mini App: API принимает `x-telegram-init-data` (из Telegram WebApp) или `x-dev-user-id` для дев-режима.

Если открываешь Web App не внутри Telegram, можно передать `?devUserId=123456789`.
Для продакшена укажи `WEB_ORIGIN` и настрой HTTPS-домен.

## Тесты
Юнит + интеграционные тесты:
- `npm run test`

Интеграционные тесты используют Postgres и по умолчанию создают схему `test`
в базе из `DATABASE_URL`. Если нужно, можно задать отдельную БД через
`TEST_DATABASE_URL`.
